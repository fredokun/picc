\documentclass[a4paper,11pt]{article}

\usepackage[utf8]{inputenc}
\usepackage{color}
\usepackage{graphicx}
\usepackage[pdfborder = {0 0 0}]{hyperref}

\definecolor{compilecolor}{gray}{0.45}
\definecolor{synchrocolor}{rgb}{0.1, 0.2, 0.8}
\title{PiThread Data Representation Specifications}
\date{\today}
\author{AurÃ©lien Deharbe and Fr\'ed\'eric Peschanski\\ UPMC -- LIP6 -- APR}

\newenvironment{program}{
  \begin{sffamily}
  \begin{scriptsize}
  \begin{tabbing}}
 {\end{tabbing}
  \end{scriptsize}
  \end{sffamily}}

\newcommand{\kw}[1]{\textsf{\textbf{#1}}}
\newcommand{\pindent}{\hspace{2em}\=}
\newcommand{\compiletime}[1]{\textcolor{compilecolor}{#1}}
\newcommand{\synchro}[1]{\textcolor{synchrocolor}{#1}}

\newcommand{\algotitle}[1]{\noindent\\ \noindent#1\par\nobreak\vspace{3pt}\hrule\vspace{6pt}}
\newcommand{\algosection}[1]{
  \phantomsection
  \addcontentsline{toc}{subsection}{#1}
  \algotitle{#1}
}
\newcommand{\myref}[1]{
  \hyperref[#1]{#1}
}

\begin{document}

\renewcommand{\contentsname}{Table of contents}
\maketitle
$ $\newline
$ $\newline
\begin{center}
\includegraphics[scale=0.45]{pithreads.png}
\end{center}
\newpage
\tableofcontents
\newpage

%%%%%%%%%%%%%%% Section COMMENTS %%%%%%%%%%%%%%%%%%
\section{Overview}

This document describes the low-level representation of values manipulated
by the pithreads backend compiler and runtime system.

There are 5 distinct categories of values manipulated in the pithreads:
\begin{itemize}
\item immediate values
\item ``by-copy'' immutable structured values
\item ``by-reference'' acyclic immutable structured values
\item ``by-reference'' acyclic mutable structured values
\item channel references
\end{itemize}

A value can be either kernel or user-defined. Immediate values
 can only be of the kernel kind.

Each value as a representation type, e.g. bool, int, float, string, etc.
Note that this representation type may be distinct from the types
manipulated at compilation-time.

%%%%%%%%%%%%%%% Section Tagged representation %%%%%%%%%%%
\section{Tagged representation}

The common representation of  values is as follows:

\begin{tabular}{|l|l|}
\hline
tag + control & data \\
\hline
\end{tabular}

with:

\begin{itemize}
\item the tag part uniquely identifies the representation type of the value. The tag is mandatory.
\item the control part provide control-level informations about the value. The control is optional.
\item the info part provide data-level informations about the value. The info is mandatory.
\end{itemize}

The expected low-level representation would be :

TODO


The exact number of bits occupied by such a value is not strictly enforced, 
however it should be consistent for a given executable backend/runtime. 
Also, 8 bits minimum are required to encode the tag part.
And one can use at most two memory words ($2\times 32$ bits on a 32bit machine, $2 \times 64$ bits on a 64 machine) to
represent a single value.

There are rooms for 256 distinct tags, with
\begin{itemize}
\item tag 0 is reserved
\item tag 1 is novalue
\item tag 2 is boolean
\item tag 3 is integer
\item tag 4 is float
\item tag 64 is tuple
\item tag 128 is string
\item tag 254 is channel
\item tag 255 is user-defined
\end{itemize}

Tags 0-254 are for kernel values.
Tag 255 is a special marker for a user-defined value.


%%%%%%%%%%%%%%% Section Immediate Values %%%%%%%%%%%
\section{Immediate Values}

Immediate values are encoded using the following scheme:

\begin{tabular}{|l|l|}
\hline
tag & info \\
\hline
\end{tabular}

The control part is thus empty, and everything except the tag describes
 the value.

There are multiple possible schemes for the low-level representation:
\begin{enumerate}
\item the tag takes one full machine word,  and so is the info part.
\item all representation bits except the tag is used for the info part.
\end{enumerate}

The following are not mandatory low level representations, but they do make sense.

\subsection{No value}

The no-value is represented by the tag $1$ and has no further information attached to it.

\subsection{Boolean values}

Here, a single machine word is enough to represent the whole value.

The representation of false is as follows:

\begin{tabular}{|l|l|}
\hline
tag & info \\
\hline
\end{tabular}

The value false has tag $2$ and information $0$.
The value true has tag $2$ and information $1$.

\subsection{Integer values}

The default integer type is the machine-word signed integer representation (i.e. int in C).

\begin{program}
\kw{typedef} \kw{struct} \_int\_value\_t \{\\
\pindent tag\_ctrl\_t tag\_ctrl ; \\
\> data\_t data;\\
\} int\_value\_t;
\end{program}

\subsection{Float values}

The default float type is the double-precision IEEE FP representation (i.e. double in C).


%%%%%%%%%%%%%%% Section String values %%%%%%%%%%%
\section{String Values}


For string values, the tag part is 128, the control part contains the number of
references to the string, and the info part contains the C-like representation of
 the string.   Note that all string are considered encoded as UTF-8.

%%%%%%%%%%%%%%% Section Tuple values %%%%%%%%%%%
\section{Tuple Values}

For tuple values, the tag is 64,  the control part contains the number of
sub-values, and the info part contains the successive sub-values.

%%%%%%%%%%%%%%% Section Channel values %%%%%%%%%%%
\section{Channel Values}

The tag is $254$ the control part gives the reference count and/or the
kind of channel  (standard, I/O, linear channel, etc.).

%%%%%%%%%%%%%%% Section User-defined values %%%%%%%%%%%
\section{User-defined Values}

The tag part is $255$, the control part contains the sub-type descriptor
 and the info part is user-defined.

\end{document}
